{% extends "dalme_public/layouts/__single_column.html" %}
{% load static %}

{% block title %}Records &mdash; {{ block.super }}{% endblock %}

{% block styles %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue-slider-component@latest/theme/default.css">
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
{% endblock %}

{% block header_extra %}
  {% include "dalme_public/includes/_breadcrumbs.html" %}
{% endblock %}

{% block main_column %}
  <div id="app" class="app inventory-list inventory-toolbar">
    <nav>
      <ul class="u-flex">
        <li>
          <small>${statusInfo}</small>
        </li>
        {% include "dalme_public/includes/_pagination.html" %}

        <li class="search ml-auto">
          <input
            type="search"
            placeholder="Search"
            v-model="search"
            :value="search"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
          >
          <div
            class="btn search-button clear-search clear-search-box"
            :class="{ 'd-none' : search == null }"
            @click="searchBoxClear"
          >Clear</div>
        </li>
        <li class="dropdown p-0 nav_button">
          <div class="filter dropdown-button" id="filter_menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span>Filter</span>
            <i class="fa fa-sort fa-sm" aria-hidden="true"></i>
          </div>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="filter_menu">
            <b-form method="get" class="filter-form u-flex">
              <div class="position-relative">
                <b-form-select
                  class="mb-2"
                  :options="choices.corpusChoices"
                  @change="setCorpus"
                  v-model="corpus">
                </b-form-select>
                <div
                  class="clear-select"
                  v-if="corpus !== ''"
                  v-on:click.stop="clearSelect('corpus')">
                  <i class="fa fa-times"></i>
                </div>
              </div>
              <div class="position-relative">
                <b-form-select
                  class="mb-2"
                  :options="choices.collectionChoices"
                  @input="setCollection"
                  v-model="collection">
                </b-form-select>
                <div
                  class="clear-select"
                  v-if="collection !== ''"
                  v-on:click.stop="clearSelect('collection')">
                  <i class="fa fa-times"></i>
                </div>
              </div>
              <div class="position-relative">
                <b-form-select
                  class="mb-2"
                  :options="choices.sourceTypeChoices"
                  @input="setSourceType"
                  v-model="sourceType">
                </b-form-select>
                <div
                  class="clear-select"
                  v-if="sourceType !== ''"
                  v-on:click.stop="clearSelect('sourceType')">
                  <i class="fa fa-times"></i>
                </div>
              </div>
              <div class="position-relative">
                <b-form-select
                  class="mb-3"
                  :options="choices.localeChoices"
                  @input="setLocale"
                  v-model="locale">
                </b-form-select>
                <div
                  class="clear-select"
                  v-if="locale !== ''"
                  v-on:click.stop="clearSelect('locale')">
                  <i class="fa fa-times"></i>
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="position-relative">
                <label class="label">Filter by date</label>
                <vue-slider
                  ref="slider"
                  v-model="date"
                  tooltip="always"
                  lazy="true"
                  stop-propagation="true"
                  :min="dateMin"
                  :max="dateMax"
                >
                </vue-slider>
              </div>
              <div class="dropdown-divider mb-3"></div>
              <b-form-checkbox
                class="mb-2 ml-1"
                id="imageCheckbox"
                @input="setHasImage"
                v-model="hasImage">
                Show only records with images
              </b-form-checkbox>
              <b-form-checkbox
                class="mb-2 ml-1"
                id="transcriptionCheckbox"
                @input="setHasTranscription"
                v-model="hasTranscription">
                Show only records with transcriptions
              </b-form-checkbox>
            </b-form>
          </div>
        </li>

        <li v-if="showModes" id="detail" class="mode detail nav_button" v-bind:class="{ active: mode == 'detail' }" @click="setMode">
          <i class="fa fa-th-large" aria-hidden="true"></i>
        </li>
        <li v-if="showModes" id="wide" class="mode wide nav_button" v-bind:class="{ active: mode == 'wide' }" @click="setMode">
          <i class="fa fa-th-list" aria-hidden="true"></i>
        </li>
        <li v-if="showModes" id="compact" class="mode compact nav_button" v-bind:class="{ active: mode == 'compact' }" @click="setMode">
          <i class="fa fa-bars" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>

    <beat-loader v-if="spinner" :loading="spinner" color="#aaa"></beat-loader>
    <section v-else class="inventory-container" :class="mode">
      <template v-if="mode === 'compact'">
        <p v-if="noResults">No records found.</p>
        <div v-else class="u-grid inventories">
          <div class="grid-row-wrapper compact u-contents">
            <span class="heading first">
              <strong @click="toggleNameOrder">Name</strong>
              <template v-if="nameOrder">
                <i v-if="nameOrder.includes('-')" class="fa fa-caret-down order-icon" aria-hidden="true"></i>
                <i v-else class="fa fa-caret-up order-icon" aria-hidden="true"></i>
              </template>
            </span>
            <span class="heading">
              <strong @click="toggleSourceTypeOrder">Type</strong>
              <template v-if="sourceTypeOrder">
                <i v-if="sourceTypeOrder.includes('-')" class="fa fa-caret-down order-icon" aria-hidden="true"></i>
                <i v-else class="fa fa-caret-up order-icon" aria-hidden="true"></i>
              </template>
            </span>
            <span class="heading">
              <strong @click="toggleDateOrder">Date</strong>
              <template v-if="dateOrder">
                <i v-if="dateOrder.includes('-')" class="fa fa-caret-down order-icon" aria-hidden="true"></i>
                <i v-else class="fa fa-caret-up order-icon" aria-hidden="true"></i>
              </template>
            </span>
            <!-- Placeholder element to regulate the grid. -->
            <span class="heading last"></span>
          </div>

          <template v-for="(record, index) in records" :key="index">
            <div class="grid-row-wrapper compact u-contents">
              <span class="inventory-field name">
                <a :href="recordUrl(record)">
                  ${record.name}<span class="short-name"> ${record.short_name}</span>
                </a>
              </span>
              <span class="inventory-field record-type">${record.record_type}</span>
              <span class="inventory-field date">${record.date}</span>
              <span class="inventory-field icons">
                <i v-if="record.no_folios > 0" class="fas fa-file ml-auto"></i>
                <i v-if="record.has_transcriptions" class="fas fa-file-image"></i>
              </span>
            </div>
          </template>
        </template>

        <template v-if="mode === 'wide'">
          <template v-for="(record, index) in records" :key="index">
              <a class="u-flex inventory-wide" :href="recordUrl(record)">
                <div
                  class="u-flex list-thumb"
                  v-bind:style="recordThumbStyle(record)">
                </div>
                <div class="u-flex inventory-details">
                  <div class="u-flex mb-1">
                    <span class="name">${record.name}</span>
                    <span class="short-name ml-auto">${record.short_name}</span>
                  </div>
                  <div class="u-flex">
                    <div class="mr-auto">
                      ${componentInstance.truncate(record.description)}
                      <span class="u-ellipsis">...</span>
                    </div>
                    <div class="u-flex inventory-metadata flex-column">
                      <span class="city">${record.date}</span>
                      <span class="folios" v-if="record.no_folios > 1">${record.no_folios} Folios</span>
                      <span class="folios" v-else>${record.no_folios} Folio</span>
                    </div>
                  </div>
                </div>
                <div class="u-flex icons">
                  <div class="u-flex first">
                    <i class="fas fa-file"></i>
                    <span class="icon-count" :class="record.no_folios === 0 ? 'red' : ''">
                      ${record.no_folios}
                    </span>
                  </div>
                  <div class="u-flex second">
                    <i v-if="record.has_transcriptions" class="fas fa-file-alt"></i>
                    <span class="icon-count" :class="record.no_transcriptions === 0 ? 'red' : record.no_transcriptions === record.no_folios ? '' : 'yellow'">
                      ${record.no_transcriptions}
                    </span>
                  </div>
                </div>
              </a>
          </template>
        </template>

        <template v-if="mode === 'detail'">
          <template v-for="(partition, index) in partitionedRecords" :key="index">
            <div class="grid-row-wrapper detail u-contents">
              <template v-for="record in partition" :key="record.id">
                <div
                  class="detail-thumb"
                  v-bind:style="recordThumbStyle(record)">
                  <a
                    class="inventory-detail u-flex"
                    :href="recordUrl(record)">
                      <div class="u-flex top">
                        <p>${record.name}</p>
                        <div class="u-flex icons">
                          <div class="u-flex first">
                            <i v-if="record.has_transcriptions" class="fas fa-file"></i>
                            <span class="icon-count" :class="record.no_folios === 0 ? 'red' : ''">
                              ${record.no_folios}
                            </span>
                          </div>
                          <div class="u-flex first">
                            <i v-if="record.has_images" class="fas fa-file-image"></i>
                            <span class="icon-count" :class="record.no_images === 0 ? 'red' : record.no_images === record.no_folios ? '' : 'yellow'">
                              ${record.no_images}
                            </span>
                          </div>
                          <div class="u-flex">
                            <i v-if="record.has_transcriptions" class="fas fa-file-alt"></i>
                            <span class="icon-count" :class="record.no_transcriptions === 0 ? 'red' : record.no_transcriptions === record.no_folios ? '' : 'yellow'">
                              ${record.no_transcriptions}
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="u-flex bottom">
                        <span class="short-name">${record.short_name}</span>
                        <span class="city">${record.date}</span>
                      </div>

                      <div class="modal-description" v-if="recordDetailHover === record.id">
                        ${componentInstance.truncate(record.description, 35)} [...]
                      </div>
                  </a>
                </div>
              </template>
            </div>
          </template>
        </template>
    </section>
    <div v-if="!spinner" class="pager">
      <ul class="pagination">
        {% include "dalme_public/includes/_pagination.html" %}
      </ul>
    </div>
</div>

{% endblock %}

{% block js_foot %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-slider-component@latest/dist/vue-slider-component.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-spinner@1.0.4/dist/vue-spinner.min.js"></script>
  <script type="text/javascript" src="{% static 'js/lodash-debounce.js' %}"></script>
  <script>
    Vue.component('beat-loader', VueSpinner.BeatLoader);
    const app = new Vue({
      el: '#app',
      delimiters: ['${', '}'],
      created() {
        this.fetchData();
        this.fetchChoices();
        window.componentInstance = this;
        window.addEventListener('resize', this.onResize);
      },
      components: {
        'vue-slider': window['vue-slider-component'],
      },
      data: {
        fetching: false,
        records: null,
        thumbnails: {},
        next: null,
        previous: null,
        count: null,
        totalPages: null,
        currentPage: null,
        pageNumbers: [],
        showFirst: false,
        showLast: false,
        pageStart: null,
        pageEnd: null,
        search: new URLSearchParams(window.location.search).get('search'),
        showFilters: false,
        corpus: '',
        mode: 'wide',
        collection: '',
        sourceType: '',
        date: [1200, 1500],
        locale: '',
        hasImage: null,
        hasTranscription: null,
        nameOrder: 'name',
        sourceTypeOrder: null,
        dateOrder: null,
        choices: {},
        recordDetailHover: false,
        windowWidth: window.innerWidth,
        hasThumb: false
      },
      watch: {
        records: 'fetchThumbnails',
        search: debounce(function() {
          this.filterData('search', this.search)
        }, 300),
        date: debounce(function() {
          const [min, max] = this.date;
          if (min === this.dateMin && max === this.dateMax) {
            const params = this.setParam('date_range', null).toString();
            this.updateURL(params);
            this.fetchData();
          } else {
            this.filterData('date_range', this.date);
          }
        }, 250),
      },
      computed: {
        showModes() {
          return this.windowWidth >= 900;
        },
        dateMin() {
          return 1200;
        },
        dateMax() {
          return 1500;
        },
        isFiltered() {
          return [
            this.corpus,
            this.collection,
            this.sourceType,
            this.date,
            this.hasImage,
            this.hasTranscription,
            this.locale
          ].some(value => value);
        },
        endpoint() {
          return '/api/public/sources';
        },
        choicesEndpoint() {
          return '/api/public/choices';
        },
        thumbnailEndpoint() {
          return '/api/public/thumbnails';
        },
        spinner() {
          return (this.records === null) || this.fetching == true;
        },
        noResults() {
          return Array.isArray(this.records) && !this.records.length;
        },
        statusInfo() {
          if (this.noResults) {
            return 'No records found';
          } else if (this.pageStart && this.pageEnd && this.count) {
            return `Showing records ${this.pageStart} to ${this.pageEnd} of ${this.count}`;
          } else {
            return ''
          }
        },
        url() {
          return location.protocol + '//' + location.host + location.pathname;
        },
        currentParams() {
          return new URLSearchParams(window.location.search);
        },
        partitionedRecords() {
          const partition = 3;
          return this.records
            ? Array(Math.ceil(this.records.length / partition))
                .fill()
                .map((_, index) => index * partition)
                .map(begin => this.records.slice(begin, begin + partition))
            : null;
        },
      },
      methods: {
        recordThumbStyle(record) {
          const thumbnail = Object.keys(this.thumbnails).length
            ? this.thumbnails[record.id]
            : null;
          if (thumbnail) {
            return {
              'background-image': `url("${thumbnail}")`,
              'background-size': 'cover',
              'background-origin': 'content-box',
              'background-clip': 'content-box',
            };
          } else {
            return false;
          }
        },
        onResize(e) {
          this.windowWidth = window.innerWidth;
          if (this.windowWidth < 900) {
            this.mode = 'compact';
          }
        },
        toggleHover(uid = false) {
          this.recordDetailHover = uid;
        },
        truncate(str, max = 25) {
          const array = str.trim().split(' ');
          const ellipsis = array.length > max ? ' [...]' : '';
          return array.slice(0, max).join(' ');
        },
        setMode(e) {
          this.mode = e.currentTarget.id;
        },
        setCorpus() {
          const value = this.corpus ? this.corpus : '';
          this.filterData('corpus', value);
        },
        setCollection() {
          const value = this.collection ? this.collection : '';
          this.filterData('collection', value);
        },
        setSourceType() {
          const value = this.sourceType ? this.sourceType : '';
          this.filterData('source_type', value);
        },
        setHasImage() {
          this.filterData('has_image', !this.hasImage);
        },
        setHasTranscription() {
          this.filterData('has_transcription', !this.hasTranscription);
        },
        setLocale() {
          const value = this.locale ? this.locale : '';
          this.filterData('locale', value);
        },
        toggleNameOrder() {
          this.sourceTypeOrder = null;
          this.dateOrder = null;
          this.nameOrder = this.nameOrder
            ? this.nameOrder === 'name'
              ? this.nameOrder = '-name'
              : this.nameOrder = 'name'
            : this.nameOrder = '-name';
          this.filterData('order_by', this.nameOrder);
        },
        toggleSourceTypeOrder() {
          this.nameOrder = null;
          this.dateOrder = null;
          this.sourceTypeOrder = this.sourceTypeOrder
            ? this.sourceTypeOrder === 'source_type'
              ? this.sourceTypeOrder = '-source_type'
              : this.sourceTypeOrder = 'source_type'
            : this.sourceTypeOrder = '-source_type';
          this.filterData('order_by', this.sourceTypeOrder);
        },
        toggleDateOrder() {
          this.nameOrder = null;
          this.sourceTypeOrder = null;
          this.dateOrder = this.dateOrder
            ? this.dateOrder === 'date'
              ? this.dateOrder = '-date'
              : this.dateOrder = 'date'
            : this.dateOrder = '-date'
          this.filterData('order_by', this.dateOrder);
        },
        destructureParams() {
          let params = {};
          this.currentParams.forEach((value, key) => {
            const camelized = key.replace(/(_\w)/g, k => k[1].toUpperCase());
            if (['collection', 'corpus', 'source_type', 'locale'].includes(key)) {
              value = this.choices[`${camelized}Choices`]
                .filter(item => {
                  return key === 'source_type'
                    ? item.id == value
                    : item.id === parseInt(value);
                });
            }
            return params[camelized] = typeof value === 'object' ? value[0] : value;
          });
          return params;
        },
        fetchChoices() {
          fetch(this.choicesEndpoint)
            .then(response => response.json())
            .then(data => {
              this.choices = data;
              const params = this.destructureParams();
              for (let [key, value] of Object.entries(params)) {
                this[key] = value;
              }
            });
        },
        fetchData(url = null) {
          this.fetching = true;
          fetch(url || `${this.endpoint}/?${this.currentParams.toString()}`)
            .then(response => response.json())
            .then(data => {
              this.records = data.results;
              this.next = data.next;
              this.previous = data.previous;
              this.count = data.count;
              this.totalPages = data.totalPages;
              this.currentPage = data.currentPage;
              this.pageNumbers = data.page_numbers;
              this.pageStart = data.page_start,
              this.pageEnd = data.page_end,
              this.showFirst = !data.page_numbers.includes(1);
              this.showLast = !data.page_numbers.includes(data.totalPages);
              this.fetching = false;
            });
        },
        async fetchThumbnails() {
          const records = this.records.filter(record =>
            record.image_ref !== null && !(record.id in this.thumbnails)
          );
          await Promise.all(records.map(record => {
            fetch(`${this.thumbnailEndpoint}/?image_ref=${record.image_ref}`)
              .then(response => response.json())
              .then(data => {
                this.thumbnails[record.id] = data.image_url;
                // Not ideal.
                this.$forceUpdate();
              })
            }));
        },
        setParam(key, value) {
          let params = this.currentParams;
          if (!value) {
            params.delete(key);
          } else {
            params.set(key, value);
          }
          return params;
        },
        updateURL(params) {
          const url = params ? `${this.url}?${params}` : this.url;
          window.history.pushState(null, null, url);
        },
        searchBoxClear() {
          this.search = null
        },
        clearSelect(field) {
          this.filterData(field, '');
          this[field] = '';
        },
        filterData(key, value) {
          const params = this.setParam(key, value).toString();
          this.fetchData(`${this.endpoint}/?${params}`);
          this.updateURL(params);
        },
        recordUrl(record) {
          return `${location.pathname}${record.id}`;
        },
        handlePreviousPage() {
          if (this.previous) {
            const params = this.setParam('page', this.previous).toString();
            this.fetchData(`${this.endpoint}/?${params}`);
            this.updateURL(params);
          }
        },
        handleNextPage() {
          if (this.next) {
            const params = this.setParam('page', this.next).toString();
            this.fetchData(`${this.endpoint}/?${params}`);
            this.updateURL(params);
          }
        },
        handlePage(page) {
          const params = this.setParam('page', page).toString();
          this.fetchData(`${this.endpoint}/?${params}`);
          this.updateURL(params);
        },
      },
    });
  </script>
{% endblock %}
